name: Build eBook

# Workflow to build .epub and .mobi eBooks from the repository's markdown content
# This workflow uses the Python build script to assemble all sections and chapters
# into a complete book with table of contents and publishes it as a GitHub Release

on:
  # Allow manual triggering from GitHub Actions tab only
  workflow_dispatch:

# Set permissions for creating releases
permissions:
  contents: write

jobs:
  build-ebook:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        # Install required Python packages
        pip install PyYAML
        
        # Install Pandoc for epub generation
        sudo apt-get update
        sudo apt-get install -y pandoc
        
        # Install Calibre for mobi generation
        sudo apt-get install -y calibre
        
        # Verify installations
        python3 --version
        pandoc --version
        ebook-convert --version
    
    - name: Build eBook using Python script
      run: |
        # Create output directory
        mkdir -p dist
        
        # Run the Python build script
        python3 build_book.py dist
        
        # Verify output files
        ls -la dist/
        echo "Build completed successfully"
    
    - name: Generate release tag
      id: tag
      run: |
        # Generate a unique release tag based on current timestamp
        TAG="v$(date +%Y.%m.%d-%H%M%S)"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Generated release tag: $TAG"
    
    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        release_name: "–£–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π –º–∏—Ä –º–µ—Ç–∞–ª–ª–æ–≤ ${{ steps.tag.outputs.tag }}"
        body: |
          üìö **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è eBook –≤–µ—Ä—Å–∏—è "–£–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π –º–∏—Ä –º–µ—Ç–∞–ª–ª–æ–≤"**
          
          –≠—Ç–∞ –∫–Ω–∏–≥–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏–∑ –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ –≥–ª–∞–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º.
          
          **–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
          - üìñ **EPUB** - –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –∫–Ω–∏–≥ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
          - üì± **MOBI** - –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ Amazon Kindle
          
          **–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
          - –ß–∞—Å—Ç—å 1: –ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏–∏ (8 –≥–ª–∞–≤)
          - –ß–∞—Å—Ç—å 2: –û—Å–Ω–æ–≤—ã –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏–∏ (4 –≥–ª–∞–≤—ã)  
          - –ß–∞—Å—Ç—å 3: –ì–∞–ª–µ—Ä–µ—è –º–µ—Ç–∞–ª–ª–æ–≤ (18 –≥–ª–∞–≤)
          - –ß–∞—Å—Ç—å 4: –ú–µ—Ç–∞–ª–ª—ã –≤–æ–∫—Ä—É–≥ –Ω–∞—Å (6 –≥–ª–∞–≤)
          - –ß–∞—Å—Ç—å 5: –ü—Ä–∞–∫—Ç–∏–∫–∞ –∏ –±—É–¥—É—â–µ–µ (6 –≥–ª–∞–≤)
          
          –í—Å–µ–≥–æ: **42 –≥–ª–∞–≤—ã** —Å –ø–æ–ª–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º –∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è–º–∏.
          
          > –ö–Ω–∏–≥–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤ –∏ –≤—Å–µ—Ö, –∫—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏–µ–π –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤–µ–¥–µ–Ω–∏–µ–º.
        draft: false
        prerelease: false
    
    - name: Upload EPUB to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/little-book-of-metals-ru.epub
        asset_name: little-book-of-metals-ru.epub
        asset_content_type: application/epub+zip
    
    - name: Upload MOBI to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/little-book-of-metals-ru.mobi
        asset_name: little-book-of-metals-ru.mobi
        asset_content_type: application/x-mobipocket-ebook